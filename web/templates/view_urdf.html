<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>File API</title>

        <link rel="stylesheet" >
    </head>

    <body>
        <!-- NOTE: importing scripts works with relative path for standalone version or with "url_for_static" when called by FLASK!-->
        <!-- <script src="../static/build/three.js"></script> -->
        <script type="text/javascript" src="{{ url_for('static', filename='/build/three.js') }}"></script>
        
        <script type="text/javascript" src="{{ url_for('static', filename='/build/js-yaml.min.js') }}"></script>

        <script type="text/javascript" src="{{ url_for('static', filename='URDF_viewer.js') }}"></script>
        
        <script type="text/javascript" src="{{ url_for('static', filename='/examples/js/controls/OrbitControls.js') }}"></script>
        <script type="text/javascript" src="{{ url_for('static', filename='/examples/js/controls/TransformControls.js') }}"></script>
        <script type="text/javascript" src="{{ url_for('static', filename='/examples/js/loaders/STLLoader.js') }}"></script>
        <script type="text/javascript" src="{{ url_for('static', filename='/examples/js/loaders/ColladaLoader.js') }}"></script>

        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

        <style type="text/css">
            #container {
                width: 100%;
                height: 100%;
                position: relative;
            }
            #renderer,
            #controls {
                width: 30%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
            }
            #controls {
                z-index: 10;
            }
            #selector {
                width: 20%;
                height: 100%;
                position: absolute;
                top: 0;
                right: 0;
                float: right;
                /* float:right;
                width:50px;
                height:100px; */
            }
            #selector {
                z-index: 10;
            }
            /* .range {
                float:left;
            }
            .number {
                float:right;
            } */
        </style>
        
        <div>
            Select a text file: 
            <input type="file" id="fileInput">
        </div>
        <pre id="fileDisplayArea"></pre>
        <div id = "container">
            <div id="renderer"></div>
            <div id="controls" style="overflow-y:auto;">
                <ul></ul>
            </div>
            <div id="selector" style="overflow-y:auto;">
                Select a module to add: 
                <!-- <input type="file" id="moduleInput"> -->
                <button type="button" id="addJoint">Joint</button> 
                <button type="button" id="addElbow">Elbow</button>
                <button type="button" id="addLink">Link</button> 
                <pre id="square"></pre>
            </div>
        </div>
        


        <script>
            var flag, reader, robots, doc;
            window.onload = function() {
                var fileInput = document.getElementById('fileInput');
                //var fileDisplayArea = document.getElementById('fileDisplayArea');
                //var moduleInput = document.getElementById('moduleInput');
                var addJoint = document.getElementById('addJoint');
                var addElbow = document.getElementById('addElbow');
                var addLink = document.getElementById('addLink');
                

                fileInput.addEventListener('change', function(e) {
                    var file = fileInput.files[0];
                    
                    reader = new FileReader();
                    
                    reader.onload = function(e) {
                        //fileDisplayArea.innerText = reader.result;
                        robots = URDF_viewer.showURDF(reader);
                    }
                    
                    reader.readAsText(file);  

                });

                //Old way used for adding a module: the urdf file is picked manually by the user
                //
                // moduleInput.addEventListener('change', function(e) {
                //     var file = moduleInput.files[0];    
                //     reader = new FileReader();    
                //     reader.onload = function(e) {
                //         //fileDisplayArea.innerText = reader.result;
                //         URDF_viewer.addModule(reader);
                //     }    
                //     reader.readAsText(file);      
                // });

                addJoint.onclick = function() {addModule("module_joint.yaml")};

                addElbow.onclick = function() {addModule("module_elbow.yaml")};

                addLink.onclick = function() {addModule("module_link.yaml")};
            }

            //Function to add a new module. Called at the click of the linked button
            function addModule(filename) {
                var url = 'http://127.0.0.1:5000/yaml/' + filename;
                
                //opening YAML file containing kin. and dyn. parameters and URDF path
                openfile(url, callBack_YAML)  

                //making an ajax request to the server to proceed to write the modified URDF
                $.ajax({
                    url: 'http://127.0.0.1:5000/changeURDF/',
                    data: {'module_name': filename},
                    method: 'POST',
                    success: function(data) {
                        //console.log(data)
                        $('#square').html(data['result'])
                    },
                    async: true
                });
            };

            //Function to open a file on the server side from the HTML page
            function openfile(url, cB) {
                function updateProgress (oEvent) {
                    if (oEvent.lengthComputable) {
                        var percentComplete = oEvent.loaded / oEvent.total * 100;
                        // ...
                    } else {
                        // Unable to compute progress information since the total size is unknown
                    }
                }
                function onloaded (evt) {
                    //console.log("The transfer is complete.");
                    //console.log(this.responseText); 
                    cB(xhr, url)
                }
                function transferFailed(evt) {
                    console.log("An error occurred while transferring the file.");
                }
                
                function transferCanceled(evt) {
                    console.log("The transfer has been canceled by the user.");
                }

                var xhr = new XMLHttpRequest();
                xhr.responseType = "text"
                xhr.addEventListener( "load", onloaded, true );
                xhr.addEventListener("progress", updateProgress);
                xhr.addEventListener("error", transferFailed);
                xhr.addEventListener("abort", transferCanceled);
                xhr.open( "GET", url, true );
                xhr.send();
            }
    
            //Function called when the YAML file has been opened
            function callBack_YAML(xhr, yaml_url) {
                //console.log(yaml_url)
                doc = jsyaml.load(xhr.responseText);
                //console.log(doc.urdf)
                var urdf_url = 'http://127.0.0.1:5000/' + doc.urdf;
                //console.log(urdf_url)
                
                //opening URDF file
                openfile(urdf_url, callBack_URDF)
            }

            //Function called when the URDF file has been opened
            function callBack_URDF(xhr, urdf_url) {
                var URDF_string = xhr.responseText 
                //console.log(URDF_string)
                
                //Finally addModuleYAML gets called. THREE.js 3D model gets updated
                robots = URDF_viewer.addModuleYAML(doc, URDF_string);
            }
            
        </script>

    </body>
</html>