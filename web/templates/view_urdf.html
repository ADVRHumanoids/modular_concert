<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>URDF builder</title>

        <!-- <link rel="stylesheet" > -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    </head>

    <body>
        <!-- NOTE: importing scripts works with relative path for standalone version or with "url_for_static" when called by FLASK!-->
        <!-- <script src="../static/js/three.js"></script> -->
        <script type="text/javascript" >
            var CURRENT_PARENT = '';
            
            function updateShownButtons(lastModule_type, count, lastSize) {

                if (count>0)
                    removeLast.style.display="block";
                else
                    removeLast.style.display="none";
                
            }
        </script>
        
        <script type="text/javascript" src="{{ url_for('static', filename='/js/three.js') }}"></script>
        
        <script type="text/javascript" src="{{ url_for('static', filename='/js/js-yaml.min.js') }}"></script>

        <script type="text/javascript" src="{{ url_for('static', filename='URDF_viewer.js') }}"></script>
        
        <script type="text/javascript" src="{{ url_for('static', filename='/examples/js/controls/OrbitControls.js') }}"></script>
        <script type="text/javascript" src="{{ url_for('static', filename='/examples/js/controls/TransformControls.js') }}"></script>
        <script type="text/javascript" src="{{ url_for('static', filename='/examples/js/loaders/STLLoader.js') }}"></script>
        <script type="text/javascript" src="{{ url_for('static', filename='/examples/js/loaders/ColladaLoader.js') }}"></script>

        <script type="text/javascript" src="{{ url_for('static', filename='/examples/js/renderers/Projector.js') }}"></script>

        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

        <style type="text/css">
            html, body {
                height: 100%;
                margin:0
            }
            #header {
                position: relative;
                top: 50%;
                left: 50%;
            }
            #container {
                width: 100%;
                height: 100%;
                position: relative;
                min-height: 100%;
            }
            #renderer,
            #controls {
                width: 30%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
            }
            #controls {
                z-index: 5;
            }
            #selector {
                width: 20%;
                height: 100%;
                position: absolute;
                top: 0;
                right: 0;
                float: right;
                display: none;
                /* float:right;
                width:50px;
                height:100px; */
            }
            #selector {
                z-index: 5;
            }
            #header {
                position: absolute;
                top: 0;
                left: 0;
            }
            #header {
                z-index: 10;
            }
            #removeLast {
                background-color: rgb(206, 33, 33);
                border: none;
                position: absolute;
                bottom: 0;
                right: 20%;
                font-size: 19px;
                color: white;
                padding: 12px 16px;
                display: none;
            }
            #syncHardware {
                background-color: rgb(31, 101, 206);
                border: none;
                position: absolute;
                bottom: 0;
                right: 35%;
                font-size: 19px;
                color: white;
                padding: 11px 16px;
                vertical-align: bottom;
                display: none;
            }
            #addJointElbow {
                background-image: url(images/joint_elbow.png);
                background-size: 100% 100%;
                height: 140px; 
                width: 100%;
                text-align: center;
                /* display: none; */
                font-size: 16px;
            }
            
            button > div {
                padding-top: 50%;
            }
             /* The switch - the box around the slider */
            .switch {
                position: relative;
                display: inline-block;
                width: 120px;
                height: 50px;
                /* background: rgb(31, 101, 206); */
            }

            /* Hide default HTML checkbox */
            .switch input {
            opacity: 0;
            width: 0;
            height: 0;
            }

            /* The slider */
            .slider {
            position: absolute;
            /* display: none; */
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            }

            .slider:before {
            position: absolute;
            content: "";
            height: 38px;
            width: 38px;
            left: 6px;
            bottom: 6px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            }

            input:not(:checked) + .slider{
                background-color: rgb(31, 101, 206)
            }

            input:checked + .slider {
            background-color: rgb(206, 33, 33);
            }

            input:focus + .slider {
            box-shadow: 0 0 1px rgb(206, 33, 33);
            }

            input:checked + .slider:before {
            -webkit-transform: translateX(70px);
            -ms-transform: translateX(70px);
            transform: translateX(70px);
            }

            /* Rounded sliders */
            .slider.round {
            border-radius: 34px;
            }

            .slider.round:before {
            border-radius: 50%;
            } 

            /* divisions for text around toggle switch */
            #div-switchWrapper {
                /* border: solid; */
                width: 350px;
                position: absolute;
                display: inline-block;
                right: 40%;
                /* padding-top: 10px;
                padding-bottom: 10px; */
                top: 0;
                height: 90px;
            }

            #div-BuildingMode {
                display: inline-block;
                /* border: solid; */
                width: 100px;
                position: relative;
                left: 0%;
                top: 15px;
                text-align: center;
                font-size: 20px;
                font-weight: bold;
                font-family: Verdana, Geneva, Tahoma, sans-serif;
                /* background-color: rgb(31, 101, 206); */
                color: rgb(31, 101, 206);
            }

            #div-switch {
                /* border: solid; */
                display: inline-block;
                width: 120px;
                vertical-align: middle;
            }

            #div-DiscoveryMode {
                display: inline-block;
                /* border: solid; */
                width: 100px;
                position: relative;
                right: 0%;
                top: 15px;
                text-align: center;
                font-size: 20px;
                font-weight: bold;
                font-family: Verdana, Geneva, Tahoma, sans-serif;
                /* background-color: rgb(206, 33, 33); */
                color:  rgb(206, 33, 33);
            }
            
            /* .range {
                float:left;
            }
            .number {
                float:right;
            } */
        </style>
        
        
        <!-- <pre id="fileDisplayArea"></pre> -->
        <div id = "container">
            <div id="header" style="overflow-y:auto;">
                Select a text file: 
                <input type="file" id="fileInput">
            </div>
            <div id="renderer"></div>
            <div id="controls" style="overflow-y:auto;">
                <ul></ul>
            </div>
            <!-- Rounded switch -->
            <div id="div-switchWrapper">
                <div id="div-BuildingMode">Building Mode</div>
                <div id="div-switch">
                    <label class="switch" id="modeSwitch" style="overflow-y:auto;">
                        <input type="checkbox" id="modeInput">
                        <span class="slider round" id="modeSwitchSlider" style="overflow-y:auto;"></span>
                    </label>
                </div>
                <div id="div-DiscoveryMode">Discovery Mode</div>
            </div>
            <button id=removeLast class="btn"><i class="fa fa-trash"></i> Remove Module</button>
            <button id=syncHardware class="btn"><span style="padding-right: 4px"><i class="material-icons">developer_board</i></span>Sync with hardware</button>
            <div id="selector" style="overflow-y:auto;">
                Select a module to add: 
                <!-- <input type="file" id="moduleInput"> -->
                <button type="button" id="addElbowJoint"><div>Elbow joint</div></button>
                <button type="button" id="addSlaveCube"><div>Slave cube</div></button>
                <button type="button" id="addYawJoint"><div>Yaw joint</div></button>
                <button type="button" id="addDoubleElbowJoint"><div>Double Elbow joint</div></button>
                <!-- <button type="button" id="remove"><div>Remove module</div></button> -->
            </div>
        </div>
        


        <script>
            var flag, reader, robots, doc;
            var size = 3;
            var buildingModeON = true;
            var erasePrevious = false;
            window.onload = function() {
                var fileInput = document.getElementById('fileInput');
                var modeInput = document.getElementById('modeInput');
                //var fileDisplayArea = document.getElementById('fileDisplayArea');
                //var moduleInput = document.getElementById('moduleInput');
                var selector = document.getElementById('selector')
                var addJoint = document.getElementById('addJoint');
                var addElbow = document.getElementById('addElbow');
                var addLink = document.getElementById('addLink');
                var addLink500 = document.getElementById('addLink500mm');
                var addLink700 = document.getElementById('addLink700mm');
                var addSizeAdapter_Big2Medium = document.getElementById('addSizeAdapter_Big2Medium');
                var addSizeAdapter_Big2Small = document.getElementById('addSizeAdapter_Big2Small');
                var addSizeAdapter_Medium2Small = document.getElementById('addSizeAdapter_Medium2Small');
                var addSlaveCube = document.getElementById('addSlaveCube');
                var removeLast = document.getElementById('removeLast');
                var syncHardware = document.getElementById('syncHardware');
                var addElbowJoint = document.getElementById('addElbowJoint');
                var modeSwitch = document.getElementById('modeSwitch');
                var modeSwitchSlider = document.getElementById('modeSwitchSlider');
                var addYawJoint = document.getElementById('addYawJoint');
                var addDoubleElbowJoint = document.getElementById('addDoubleElbowJoint');

                urdfViewer._init();
                requestURDF();

                fileInput.addEventListener('change', function(e) {
                    var file = fileInput.files[0];
                    console.log(file)
                    reader = new FileReader();
                    
                    reader.onload = function(e) {
                        //fileDisplayArea.innerText = reader.result;
                        document.getElementById('header').style.display="none";
                        //robots = urdfViewer.showURDF(reader);
                        selector.style.display = 'block';
                        // modeSwitch.style.display = 'inline-block';
                        // modeSwitchSlider.style.display = 'block';
                        syncHardware.style.display = 'inline-flex';

                        if(modeInput.checked) {
                            console.log("Discovery mode on")
                        }
                        else {
                            console.log("Building mode on")
                        }

                        //console.log(reader.result)
                        $.ajax({
                            url: 'http://127.0.0.1:5000/openFile/',
                            data: {'file': reader.result},
                            method: 'POST',
                            // contentType: false,
                            // processData: false,
                            success: function(data) {
                                // Initialize the urdfViewer class: create a scene, renderer, etc.
                                urdfViewer._init();
                                console.log(data['string'])
                                robots = urdfViewer.showURDF(data['string']);
                            },
                            async: true
                        });
                    }
                    
                    reader.readAsText(file);  

                });

                modeInput.addEventListener('change', function(e) {
                    $.ajax({
                        url: 'http://127.0.0.1:5000/changeMode/',
                        data: {'state': modeInput.checked},
                        method: 'POST',
                        // contentType: false,
                        // processData: false,
                        success: function(data) {
                            console.log(modeInput.checked)
                            if(urdfViewer.robots[1]) {
                                urdfViewer.removeLastURDF()
                            }
                            urdfViewer.removeLastURDF();
                            //urdfViewer.removeLastURDF()
                            console.log(data['building mode'])
                            console.log(data['discovery mode'])
                            //robots = urdfViewer.showURDF(data['string']);
                            if((data['building mode'] == true) && (data['discovery mode'] == false)){
                                buildingModeON = true;
                                erasePrevious = false;
                                requestURDF();
                            }
                            else {
                                buildingModeON = false;
                            }
                            console.log(buildingModeON);
                        },
                        async: true
                    }); 
                });


                //Old way used for adding a module: the urdf file is picked manually by the user
                //
                // moduleInput.addEventListener('change', function(e) {
                //     var file = moduleInput.files[0];    
                //     reader = new FileReader();    
                //     reader.onload = function(e) {
                //         //fileDisplayArea.innerText = reader.result;
                //         urdfViewer.addModule(reader);
                //     }    
                //     reader.readAsText(file);      
                // });

                addSlaveCube.onclick = function() {addCube("mastercube", size)};

                removeLast.onclick = function() {removeModule()};

                syncHardware.onclick = function() {syncHW()};

                addElbowJoint.onclick = function() {addModule("module_joint_elbow_AVOCADO", size)};
                
                addYawJoint.onclick = function() {addModule("module_joint_yaw_AVOCADO", size)};

                addDoubleElbowJoint.onclick = function() {addModule("module_joint_double_elbow_AVOCADO", size)};
            }

            //Function to add a new module. Called at the click of the linked button
            function addModule(modulename, size_value) {
                var offset = parseFloat(prompt("Enter the angle offset for the module:", "0"));
                var reverse = confirm("Do you want to connect it backwards?");
                
                //opening YAML file containing kin. and dyn. parameters and URDF path
                //var url = 'http://127.0.0.1:5000/yaml/' + filename;
                //openfile(url, callBack_YAML)  
                switch (size_value) {
                    case 3:
                        size_tag = '_B';
                        break;
                    case 2:
                        size_tag = '_M';
                        break;
                    case 1:
                        size_tag = '_S';
                        break;
                }
                
                if (modulename.indexOf("module_size_adapter") >= 0) {
                    filename = modulename + '.yaml'
                } else {
                    filename = modulename + size_tag + '.yaml'
                }
                
                console.log()
                //making an ajax request to the server to proceed to write the modified URDF
                $.ajax({
                    url: 'http://127.0.0.1:5000/changeURDF/',
                    data: {'module_name': filename, 'parent': CURRENT_PARENT, 'angle_offset': offset, 'reverse': reverse},
                    method: 'POST',
                    success: function(data) {
                        console.log(data)
                        robots = urdfViewer.updateURDF(data['result'])//, data['lastModule_name'])
                        // size = data['size']
                        updateShownButtons(data['lastModule_type'], data['count'], data['size'])
                        // console.log(size)
                        CURRENT_PARENT = data['lastModule_name']
                        //write the file
                        writeRequest(data['result'])
                    },
                    async: true
                });

            };

            function requestURDF(){
                $.ajax({
                    url: 'http://127.0.0.1:5000/requestURDF/',
                    data: {'mode': buildingModeON},
                    method: 'POST',
                    // contentType: false,
                    // processData: false,
                    success: function(data) {
                        // Initialize the urdfViewer class: create a scene, renderer, etc.
                        //urdfViewer._init();
                        console.log(data['string'])
                        robots = urdfViewer.showURDF(data['string']);

                        selector.style.display = 'block';
                        syncHardware.style.display = 'inline-flex';
                    },
                    async: true
                });
            }

            function writeRequest(URDF_string){
                $.ajax({
                    url: 'http://127.0.0.1:5000/writeURDF/',
                    data: {'string': URDF_string},
                    method: 'POST',
                    success: function(data) {
                    console.log(data)    
                    },
                    async: true
                });
            }

            function syncHW() {
                $.ajax({
                    url: 'http://127.0.0.1:5000/syncHW/',
                    method: 'POST',
                    success: function(data) {
                        console.log(buildingModeON)
                        if(buildingModeON){
                            // If there is already a "red URDF" shown, erase it before adding the new one.
                            if(erasePrevious) {
                                urdfViewer.removeLastURDF()
                            }
                            console.log(data['string'])
                            robots = urdfViewer.addURDF(data['string'])//, data['lastModule_name'])
                            erasePrevious = true;
                            // writeRequest(data['result'])
                        }
                        else {
                            urdfViewer.removeLastURDF()
                            console.log(data['string'])
                            robots = urdfViewer.showURDF(data['string']);
                            //write the file
                            writeRequest(data['string'])
                        }
                    },
                    async: true
                });
            }

            function addCube(modulename) {
                //making an ajax request to the server to proceed to write the modified URDF
                var offset = parseFloat(prompt("Enter the angle offset for the module:", "0"));
                
                filename = modulename + '.yaml'
                $.ajax({
                    url: 'http://127.0.0.1:5000/addMasterCube/',
                    data: {'module_name': filename, 'parent': CURRENT_PARENT, 'angle_offset': offset},
                    method: 'POST',
                    success: function(data) {
                        console.log(data)
                        robots = urdfViewer.updateURDF(data['result'])//, data['lastModule_name'])
                        // size = data['size']
                        updateShownButtons(data['lastModule_type'], data['count'], data['size'])
                        // console.log(size)
                        CURRENT_PARENT = data['lastModule_name']
                        //write the file
                        writeRequest(data['result'])
                    },
                    async: true
                });

            };

            function removeModule() {
                $.ajax({
                    url: 'http://127.0.0.1:5000/removeModule/',
                    data: {'parent': CURRENT_PARENT},
                    method: 'POST',
                    success: function(data) {
                        console.log(data)
                        robots = urdfViewer.updateURDF(data['result'])
                        //size = data['size']
                        updateShownButtons(data['lastModule_type'], data['count'], data['size'])
                        //console.log(size)
                        CURRENT_PARENT = data['lastModule_name']
                        //write the file
                        writeRequest(data['result'])
                    },
                    async: true
                });
            }


            // //Function to open a file on the server side from the HTML page
            // function openfile(url, cB) {
            //     function updateProgress (oEvent) {
            //         if (oEvent.lengthComputable) {
            //             var percentComplete = oEvent.loaded / oEvent.total * 100;
            //             // ...
            //         } else {
            //             // Unable to compute progress information since the total size is unknown
            //         }
            //     }
            //     function onloaded (evt) {
            //         //console.log("The transfer is complete.");
            //         //console.log(this.responseText); 
            //         cB(xhr, url)
            //     }
            //     function transferFailed(evt) {
            //         console.log("An error occurred while transferring the file.");
            //     }
                
            //     function transferCanceled(evt) {
            //         console.log("The transfer has been canceled by the user.");
            //     }

            //     var xhr = new XMLHttpRequest();
            //     xhr.responseType = "text"
            //     xhr.addEventListener( "load", onloaded, true );
            //     xhr.addEventListener("progress", updateProgress);
            //     xhr.addEventListener("error", transferFailed);
            //     xhr.addEventListener("abort", transferCanceled);
            //     xhr.open( "GET", url, true );
            //     xhr.send();
            // }
    
            // //Function called when the YAML file has been opened
            // function callBack_YAML(xhr, yaml_url) {
            //     //console.log(yaml_url)
            //     doc = jsyaml.load(xhr.responseText);
            //     //console.log(doc.urdf)
            //     var urdf_url = 'http://127.0.0.1:5000/' + doc.urdf;
            //     //console.log(urdf_url)
                
            //     //opening URDF file
            //     openfile(urdf_url, callBack_URDF)
            // }

            // //Function called when the URDF file has been opened
            // function callBack_URDF(xhr, urdf_url) {
            //     var URDF_string = xhr.responseText 
            //     //console.log(URDF_string)
                
            //     //Finally addModuleYAML gets called. THREE.js 3D model gets updated
            //     robots = urdfViewer.addModuleYAML(doc, URDF_string);
            // }

            
        </script>

    </body>
</html>